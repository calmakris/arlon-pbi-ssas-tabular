{
  "name": "Material Cost",
  "description": "Latest official material cost of the material. This measure is best used if analyzed by 'Material Master' and/or 'Plant'. Also If this is analyzed by 'Calendar', this measure shows the last cost within a date range.",
  "expression": [
    "VAR _isMaterialFiltered = HASONEFILTER( 'Material Costing History'[Material Number] ) || ISFILTERED( 'Material Master' )",
    "VAR _isPlantFiltered = HASONEFILTER( 'Material Costing History'[Plant] ) || ISFILTERED( 'Plant' )",
    "VAR _maxVisibleDate = ",
    "    CALCULATE(",
    "        MAX( 'Calendar'[Date] ),",
    "        FILTER(",
    "            'Calendar',",
    "            'Calendar'[Date] <= [Report Date]",
    "        )",
    "    )",
    "",
    "VAR _latestRank =",
    "    CALCULATE(",
    "        IF(",
    "            _isMaterialFiltered && _isPlantFiltered,",
    "            MIN( 'Material Costing History'[LatestRank] ),",
    "            IF(",
    "                _isMaterialFiltered,",
    "                CALCULATE(",
    "                    MIN( 'Material Costing History'[LatestRank] ),",
    "                    KEEPFILTERS( 'Plant'[Plant] IN {\"1001\", \"1501\"} )",
    "                ),",
    "                BLANK()",
    "            )",
    "        ),",
    "        FILTER(",
    "            'Material Costing History',",
    "            'Material Costing History'[Costing Start Date] <= _maxVisibleDate",
    "        )",
    "    )",
    "",
    "RETURN",
    "    IF(",
    "        ISBLANK(_latestRank),",
    "        BLANK(),",
    "        SWITCH(",
    "            TRUE(),",
    "            HASONEVALUE( Plant[Plant] ),",
    "                CALCULATE(",
    "                    AVERAGE( 'Material Costing History'[Material Cost] ),",
    "                    KEEPFILTERS( 'Material Costing History'[LatestRank] = _latestRank )",
    "                ),",
    "            CALCULATE(",
    "                AVERAGE( 'Material Costing History'[Material Cost] ),",
    "                KEEPFILTERS( 'Material Costing History'[LatestRank] = _latestRank ),",
    "                KEEPFILTERS( 'Plant'[Plant] IN {\"1001\", \"1501\"} )",
    "            )",
    "        )",
    "    )"
  ],
  "formatString": "#,0.00",
  "displayFolder": "Material Cost and Price",
  "annotations": [
    {
      "name": "TabularEditor_InPerspective",
      "value": "[\"Product Management\"]"
    }
  ]
}